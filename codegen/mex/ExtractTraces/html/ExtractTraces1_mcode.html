<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [] = ExtractTraces(<span class="var type1" id="S2T1U5">NumICA</span>,<span class="var type1" id="S3T1U6">MinThreshPixels</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% ExtractTraces v 0.90 9/19/2014</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% Using Inscopix Mosaic generated IC files and a DF/F corrected movie,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% generate accurate, sensitive traces for the cells</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="autoExtrinsicFcn" id="F2N4:B8">close</span> <span class="string">all</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% "Magic numbers"</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="var type0" id="S5T0U12">MicronsPerPix</span> = 1.22; <span class="comment">% correctish</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="var type0" id="S6T0U16">SR</span> = 20; <span class="comment">% Sampling rate in Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="var type0" id="S7T0U20">OutNoiseRad</span> = 40; <span class="comment">% Radius from cell center to calculate Noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="keyword">if</span> (nargin == 1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">    <span class="var type0" id="S3T0U31">MinThreshPixels</span> = 60;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% Load the independent components, edit them if this is the first time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="message fatal" id="M1F1C">[<span class="var type0" id="S9T0U36">ICThresh</span>,<span class="var type0" id="S10T0U37">IC</span>,<span class="var type0" id="S2T0U38">NumICA</span>,<span class="var type0" id="S11T0U39">x</span>,<span class="var type0" id="S12T0U40">y</span>] = <span class="fcn" id="F3N2:B42">EditICA</span>(<span class="var type1" id="S2T1U43">NumICA</span>,<span class="var type1" id="S3T1U44">MinThreshPixels</span>)</span>; <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="var type0" id="S14T0U47">Xdim</span> = size(<span class="var type0" id="S10T0U51">IC</span>{1},1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="var type0" id="S16T0U56">Ydim</span> = size(<span class="var type0" id="S10T0U60">IC</span>{1},2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">display(<span class="string">'Calculating signal masks'</span>); <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% Create new IC filters with values less than ICThresh zeroed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% This isolates the pixels that are part of the neuron</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">figure;hold <span class="string">on</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="var type0" id="S20T0U75">Sum_Mask</span> = zeros(size(<span class="var type0" id="S10T0U81">IC</span>{1}));</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S22T0U85">i</span> = 1:<span class="var type0" id="S2T0U88">NumICA</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">  <span class="var type0" id="S23T0U91">temp</span> = <span class="var type0" id="S10T0U93">IC</span>{<span class="var type0" id="S22T0U94">i</span>};</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">  <span class="var type0" id="S23T0U98">temp</span>(find(<span class="var type0" id="S23T0U102">temp</span> &lt; <span class="var type0" id="S9T0U104">ICThresh</span>(<span class="var type0" id="S22T0U105">i</span>))) = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">  <span class="var type0" id="S25T0U110">RawIC</span>{<span class="var type0" id="S22T0U111">i</span>} = <span class="var type0" id="S23T0U112">temp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">  <span class="var type0" id="S23T0U116">temp</span>(find(<span class="var type0" id="S23T0U120">temp</span> &gt; 0)) = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">  <span class="var type0" id="S26T0U126">ICMask</span>{<span class="var type0" id="S22T0U127">i</span>} = <span class="var type0" id="S23T0U128">temp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">  <span class="var type0" id="S27T0U132">ICnz</span>{<span class="var type0" id="S22T0U133">i</span>} = find(<span class="var type0" id="S23T0U137">temp</span> == 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">  <span class="var type0" id="S28T0U142">COM</span>{<span class="var type0" id="S22T0U143">i</span>} = centerOfMass(<span class="var type0" id="S23T0U146">temp</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">  subplot(1,2,1);plot(<span class="var type0" id="S11T0U157">x</span>{<span class="var type0" id="S22T0U158">i</span>},<span class="var type0" id="S12T0U160">y</span>{<span class="var type0" id="S22T0U161">i</span>});hold <span class="string">on</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">  <span class="var type0" id="S20T0U167">Sum_Mask</span> = <span class="var type0" id="S20T0U169">Sum_Mask</span>+<span class="var type0" id="S26T0U171">ICMask</span>{<span class="var type0" id="S22T0U172">i</span>};</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">subplot(1,2,2);imagesc(<span class="var type0" id="S20T0U182">Sum_Mask</span>);set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">display(<span class="string">'Calculating noise masks'</span>); <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S22T0U196">i</span> = 1:<span class="var type0" id="S2T0U199">NumICA</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">  <span class="var type0" id="S35T0U202">c</span> = <span class="var type0" id="S28T0U204">COM</span>{<span class="var type0" id="S22T0U205">i</span>};</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">  <span class="comment">% Identify a ring of pixels around the center</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">  <span class="keyword">for</span> <span class="var type0" id="S36T0U208">k</span> = 1:<span class="var type0" id="S14T0U211">Xdim</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">      <span class="keyword">for</span> <span class="var type0" id="S37T0U214">l</span> = 1:<span class="var type0" id="S16T0U217">Ydim</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">         <span class="var type0" id="S38T0U220">pixdist</span> = norm([<span class="var type0" id="S36T0U226">k</span> <span class="var type0" id="S37T0U227">l</span>]-<span class="var type0" id="S35T0U228">c</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">         <span class="var type0" id="S40T0U233">RingMask</span>{<span class="var type0" id="S22T0U234">i</span>}(<span class="var type0" id="S36T0U235">k</span>,<span class="var type0" id="S37T0U236">l</span>) = (<span class="var type0" id="S38T0U239">pixdist</span> &lt; <span class="var type0" id="S7T0U240">OutNoiseRad</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">      <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">  <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">  <span class="var type0" id="S41T0U244">RingMasknz</span>{<span class="var type0" id="S22T0U245">i</span>} = find(<span class="var type0" id="S40T0U251">RingMask</span>{<span class="var type0" id="S22T0U252">i</span>}(:) &gt; 0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">  <span class="var type0" id="S42T0U258">NoiseMask_idx</span>{<span class="var type0" id="S22T0U259">i</span>} = setdiff(<span class="var type0" id="S41T0U263">RingMasknz</span>{<span class="var type0" id="S22T0U264">i</span>},<span class="var type0" id="S27T0U266">ICnz</span>{<span class="var type0" id="S22T0U267">i</span>});</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">  <span class="var type0" id="S44T0U271">NoiseMask</span>{<span class="var type0" id="S22T0U272">i</span>} = zeros(size(<span class="var type0" id="S10T0U278">IC</span>{1}));</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">  <span class="var type0" id="S44T0U284">NoiseMask</span>{<span class="var type0" id="S22T0U285">i</span>}(<span class="var type0" id="S42T0U287">NoiseMask_idx</span>{<span class="var type0" id="S22T0U288">i</span>}) = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">  <span class="var type0" id="S45T0U293">NoiseMasknz</span>{<span class="var type0" id="S22T0U294">i</span>} = find(<span class="var type0" id="S44T0U299">NoiseMask</span>{<span class="var type0" id="S22T0U300">i</span>} &gt; 0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">display(<span class="string">'Loading movie data'</span>); <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">% MovieData dims are X,Y,T</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="var type0" id="S46T0U308">info</span> = h5info(<span class="string">'FLmovie.h5'</span>,<span class="string">'/Object'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="var type0" id="S48T0U315">NumFrames</span> = <span class="var type0" id="S46T0U319">info</span>.Dataspace.Size(3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="var type0" id="S49T0U325">t</span> = (1:<span class="var type0" id="S48T0U330">NumFrames</span>)/<span class="var type0" id="S6T0U331">SR</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">% initialize trace matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="var type0" id="S50T0U334">SignalTrace</span> = zeros(<span class="var type0" id="S2T0U337">NumICA</span>,<span class="var type0" id="S48T0U338">NumFrames</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="var type0" id="S51T0U341">NoiseTrace</span> = zeros(<span class="var type0" id="S2T0U344">NumICA</span>,<span class="var type0" id="S48T0U345">NumFrames</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="keyword">parfor</span> <span class="var type0" id="S22T0U348">i</span> = 1:<span class="var type0" id="S48T0U351">NumFrames</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">  display([<span class="string">'Calculating F traces for movie frame '</span>,int2str(<span class="var type0" id="S22T0U360">i</span>),<span class="string">' out of '</span>,int2str(<span class="var type0" id="S48T0U364">NumFrames</span>)]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">  <span class="var type0" id="S53T0U367">tempFrame</span> = h5read(<span class="string">'FLmovie.h5'</span>,<span class="string">'/Object'</span>,[1 1 <span class="var type0" id="S22T0U376">i</span> 1],[<span class="var type0" id="S14T0U380">Xdim</span> <span class="var type0" id="S16T0U381">Ydim</span> 1 1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">  <span class="var type0" id="S50T0U387">SignalTrace</span>(:,<span class="var type0" id="S22T0U389">i</span>) = innerloop(<span class="var type0" id="S53T0U392">tempFrame</span>,<span class="var type0" id="S2T0U393">NumICA</span>,<span class="var type0" id="S27T0U394">ICnz</span>,<span class="var type0" id="S11T0U395">x</span>,<span class="var type0" id="S12T0U396">y</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">  <span class="var type0" id="S51T0U400">NoiseTrace</span>(:,<span class="var type0" id="S22T0U402">i</span>) = noiseloop(<span class="var type0" id="S53T0U405">tempFrame</span>,<span class="var type0" id="S2T0U406">NumICA</span>,<span class="var type0" id="S45T0U407">NoiseMasknz</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="var type0" id="S57T0U410">FT</span> = PolishTraces(<span class="var type0" id="S50T0U413">SignalTrace</span>,<span class="var type0" id="S51T0U414">NoiseTrace</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">%save backup.mat</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">save <span class="string">FinalTraces.mat</span> <span class="var type0" id="S57T0U418">FT</span> <span class="var type0" id="S2T0U419">NumICA</span> <span class="var type0" id="S10T0U420">IC</span> <span class="var type0" id="S27T0U421">ICnz</span> <span class="var type0" id="S11T0U422">x</span> <span class="var type0" id="S12T0U423">y</span> <span class="var type0" id="S49T0U424">t</span> <span class="var type0" id="S35T0U425">c</span> <span class="var type0" id="S48T0U426">NumFrames</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">keyboard;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"></span></span>
</pre>
